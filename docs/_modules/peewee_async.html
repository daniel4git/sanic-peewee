<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="cn">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>peewee_async &#8212; sanic_peewee  documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for peewee_async</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">peewee-async</span>
<span class="sd">============</span>

<span class="sd">Asynchronous interface for `peewee`_ ORM powered by `asyncio`_:</span>
<span class="sd">https://github.com/05bit/peewee-async</span>

<span class="sd">.. _peewee: https://github.com/coleifer/peewee</span>
<span class="sd">.. _asyncio: https://docs.python.org/3/library/asyncio.html</span>

<span class="sd">Licensed under The MIT License (MIT)</span>

<span class="sd">Copyright (c) 2014, Alexey KinÃ«v &lt;rudy@05bit.com&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">peewee</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;peewee.async&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">aiopg</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">aiopg</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">aiomysql</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">aiomysql</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;0.5.7&#39;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">### High level API ###</span>

    <span class="s1">&#39;Manager&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PostgresqlDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PooledPostgresqlDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MySQLDatabase&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PooledMySQLDatabase&#39;</span><span class="p">,</span>

    <span class="c1">### Low level API ###</span>

    <span class="s1">&#39;execute&#39;</span><span class="p">,</span>
    <span class="s1">&#39;count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;scalar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atomic&#39;</span><span class="p">,</span>
    <span class="s1">&#39;transaction&#39;</span><span class="p">,</span>
    <span class="s1">&#39;savepoint&#39;</span><span class="p">,</span>

    <span class="c1">### Deprecated ###</span>

    <span class="s1">&#39;get_object&#39;</span><span class="p">,</span>
    <span class="s1">&#39;create_object&#39;</span><span class="p">,</span>
    <span class="s1">&#39;delete_object&#39;</span><span class="p">,</span>
    <span class="s1">&#39;update_object&#39;</span><span class="p">,</span>
    <span class="s1">&#39;sync_unwanted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;UnwantedSyncQueryError&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;peewee.async&#39;</span><span class="p">)</span>

<span class="c1">#################</span>
<span class="c1"># Async manager #</span>
<span class="c1">#################</span>


<span class="k">class</span> <span class="nc">Manager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Async peewee models manager.</span>

<span class="sd">    :param loop: (optional) asyncio event loop</span>
<span class="sd">    :param database: (optional) async database driver</span>

<span class="sd">    Example::</span>

<span class="sd">        class User(peewee.Model):</span>
<span class="sd">            username = peewee.CharField(max_length=40, unique=True)</span>

<span class="sd">        objects = Manager(PostgresqlDatabase(&#39;test&#39;))</span>

<span class="sd">        async def my_async_func():</span>
<span class="sd">            user0 = await objects.create(User, username=&#39;test&#39;)</span>
<span class="sd">            user1 = await objects.get(User, id=user0.id)</span>
<span class="sd">            user2 = await objects.get(User, username=&#39;test&#39;)</span>
<span class="sd">            # All should be the same</span>
<span class="sd">            print(user1.id, user2.id, user3.id)</span>

<span class="sd">    If you don&#39;t pass database to constructor, you should define</span>
<span class="sd">    ``database`` as a class member like that::</span>

<span class="sd">        database = PostgresqlDatabase(&#39;test&#39;)</span>

<span class="sd">        class MyManager(Manager):</span>
<span class="sd">            database = database</span>

<span class="sd">        objects = MyManager()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#: Async database driver for manager. Must be provided</span>
    <span class="c1">#: in constructor or as a class member.</span>
    <span class="n">database</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">database</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> \
               <span class="p">(</span><span class="s2">&quot;Error, database must be provided via &quot;</span>
                <span class="s2">&quot;argument or class member.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">loop</span>

        <span class="n">attach_callback</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="s1">&#39;attach_callback&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attach_callback</span><span class="p">:</span>
            <span class="n">attach_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">db</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;_loop&#39;</span><span class="p">,</span> <span class="n">loop</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">loop</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the event loop.</span>

<span class="sd">        If no event loop is provided explicitly on creating</span>
<span class="sd">        the instance, just return the current event loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">or</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if database is connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">_async_conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the model instance.</span>

<span class="sd">        :param source_: model or base query for lookup</span>

<span class="sd">        Example::</span>

<span class="sd">            async def my_async_func():</span>
<span class="sd">                obj1 = await objects.get(MyModel, id=1)</span>
<span class="sd">                obj2 = await objects.get(MyModel, MyModel.id == 1)</span>
<span class="sd">                obj3 = await objects.get(MyModel.select().where(MyModel.id == 1))</span>

<span class="sd">        All will return `MyModel` instance with `id = 1`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">Query</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">source_</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">source_</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">source_</span>

        <span class="n">conditions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="p">[(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">*</span><span class="n">conditions</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new object saved to database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">model_</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">model_</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="n">_data</span><span class="p">))</span>

        <span class="n">pk</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">inst</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>
        <span class="n">inst</span><span class="o">.</span><span class="n">_set_pk_value</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">inst</span><span class="o">.</span><span class="n">_prepare_instance</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">inst</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">get_or_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to get an object or create it with the specified defaults.</span>

<span class="sd">        Return 2-tuple containing the model instance and a boolean</span>
<span class="sd">        indicating whether the instance was created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)),</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">model_</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">defaults</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">})</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model_</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)),</span> <span class="kc">True</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the object in the database. Optionally, update only</span>
<span class="sd">        the specified fields. For creating a new object use :meth:`.create()`</span>

<span class="sd">        :param only: (optional) the list/tuple of fields or</span>
<span class="sd">                     field names to update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
        <span class="n">pk_field</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>

        <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">only_save_dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">dirty_fields</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">composite_key</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pk_part_name</span> <span class="ow">in</span> <span class="n">pk_field</span><span class="o">.</span><span class="n">field_names</span><span class="p">:</span>
                <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_part_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delete_nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete object from database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">delete_nullable</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model_class</span>
                <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delete_nullable</span><span class="p">:</span>
                    <span class="n">sq</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sq</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sq</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">create_or_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Try to create new object with specified data. If object already</span>
<span class="sd">        exists, then try to get it by unique fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">model_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)),</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">peewee</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">unique</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_</span><span class="p">,</span> <span class="o">*</span><span class="n">query</span><span class="p">)),</span> <span class="kc">False</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute query asyncronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_swap_database</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Asynchronous version of the `prefetch()` from peewee.</span>

<span class="sd">        :return: Query that has already cached data for subqueries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_swap_database</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">subqueries</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_swap_database</span><span class="p">,</span> <span class="n">subqueries</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">prefetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">))</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform *COUNT* aggregated query asynchronously.</span>

<span class="sd">        :return: number of objects in ``select()`` query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_swap_database</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">count</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="n">clear_limit</span><span class="p">))</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get single value from ``select()`` query, i.e. for aggregation.</span>

<span class="sd">        :return: result is the same as after sync ``query.scalar()`` call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_swap_database</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">scalar</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="n">as_tuple</span><span class="p">))</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open database async connection if not connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">connect_async</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close database async connection if connected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">close_async</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to `peewee.Database.atomic()` method, but returns</span>
<span class="sd">        **asynchronous** context manager.</span>

<span class="sd">        Example::</span>

<span class="sd">            async with objects.atomic():</span>
<span class="sd">                await objects.create(</span>
<span class="sd">                    PageBlock, key=&#39;intro&#39;,</span>
<span class="sd">                    text=&quot;There are more things in heaven and earth, &quot;</span>
<span class="sd">                         &quot;Horatio, than are dreamt of in your philosophy.&quot;)</span>
<span class="sd">                await objects.create(</span>
<span class="sd">                    PageBlock, key=&#39;signature&#39;, text=&quot;William Shakespeare&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">atomic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to `peewee.Database.transaction()` method, but returns</span>
<span class="sd">        **asynchronous** context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to `peewee.Database.savepoint()` method, but returns</span>
<span class="sd">        **asynchronous** context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">allow_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow sync queries within context. Close the sync</span>
<span class="sd">        database connection on exit if connected.</span>

<span class="sd">        Example::</span>

<span class="sd">            with objects.allow_sync():</span>
<span class="sd">                PageBlock.create_table(True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">allow_sync</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_swap_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Swap database for query if swappable. Return **new query**</span>
<span class="sd">        with swapped database.</span>

<span class="sd">        This is experimental feature which allows us to have multiple</span>
<span class="sd">        managers configured against different databases for single model</span>
<span class="sd">        definition.</span>

<span class="sd">        The essential limitation though is that database backend have</span>
<span class="sd">        to be **the same type** for model and manager!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">database</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">query</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclassed</span><span class="p">(</span><span class="n">peewee</span><span class="o">.</span><span class="n">PostgresqlDatabase</span><span class="p">,</span>
                              <span class="n">query</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">):</span>
            <span class="n">can_swap</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subclassed</span><span class="p">(</span><span class="n">peewee</span><span class="o">.</span><span class="n">MySQLDatabase</span><span class="p">,</span>
                              <span class="n">query</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">):</span>
            <span class="n">can_swap</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">can_swap</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">can_swap</span><span class="p">:</span>
            <span class="c1"># **Experimental** database swapping!</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">query</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
            <span class="k">return</span> <span class="n">query</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;Error, query&#39;s database and manager&#39;s database are &quot;</span>
                <span class="s2">&quot;different. Query: </span><span class="si">%s</span><span class="s2"> Manager: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">query</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">database</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_subclassed</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">classes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if all classes are subclassed from base.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">base</span><span class="p">),</span> <span class="n">classes</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter fields data **in place** with `only` list.</span>

<span class="sd">        Example::</span>

<span class="sd">            self._prune_fields(field_dict, [&#39;slug&#39;, &#39;text&#39;])</span>
<span class="sd">            self._prune_fields(field_dict, [MyModel.slug])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">only</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field_dict</span>


<span class="c1">#################</span>
<span class="c1"># Async queries #</span>
<span class="c1">#################</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute *SELECT*, *INSERT*, *UPDATE* or *DELETE* query asyncronously.</span>

<span class="sd">    :param query: peewee query instance created with ``Model.select()``,</span>
<span class="sd">                  ``Model.update()`` etc.</span>
<span class="sd">    :return: result depends on query type, it&#39;s the same as for sync ``query.execute()``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">SelectQuery</span><span class="p">):</span>
        <span class="n">coroutine</span> <span class="o">=</span> <span class="n">select</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">UpdateQuery</span><span class="p">):</span>
        <span class="n">coroutine</span> <span class="o">=</span> <span class="n">update</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">InsertQuery</span><span class="p">):</span>
        <span class="n">coroutine</span> <span class="o">=</span> <span class="n">insert</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">DeleteQuery</span><span class="p">):</span>
        <span class="n">coroutine</span> <span class="o">=</span> <span class="n">delete</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coroutine</span> <span class="o">=</span> <span class="n">raw_query</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">coroutine</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">create_object</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create object asynchronously.</span>
<span class="sd">    </span>
<span class="sd">    :param model: mode class</span>
<span class="sd">    :param data: data for initializing object</span>
<span class="sd">    :return: new object saved to database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE! Here are internals involved:</span>
    <span class="c1">#</span>
    <span class="c1"># - obj._data</span>
    <span class="c1"># - obj._get_pk_value()</span>
    <span class="c1"># - obj._set_pk_value()</span>
    <span class="c1"># - obj._prepare_instance()</span>
    <span class="c1">#</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;create_object() is deprecated, Manager.create() &quot;</span>
                  <span class="s2">&quot;should be used instead&quot;</span><span class="p">,</span>
                  <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="n">pk</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">insert</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_data</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_get_pk_value</span><span class="p">()</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_set_pk_value</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>
    
    <span class="n">obj</span><span class="o">.</span><span class="n">_prepare_instance</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">obj</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get object asynchronously.</span>

<span class="sd">    :param source: mode class or query to get object from</span>
<span class="sd">    :param args: lookup parameters</span>
<span class="sd">    :return: model instance or raises ``peewee.DoesNotExist`` if object not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;get_object() is deprecated, Manager.get() &quot;</span>
                  <span class="s2">&quot;should be used instead&quot;</span><span class="p">,</span>
                  <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">Query</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">source</span>

    <span class="c1"># Return first object from query</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">select</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">))):</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="c1"># No objects found</span>
    <span class="k">raise</span> <span class="n">model</span><span class="o">.</span><span class="n">DoesNotExist</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">delete_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delete_nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete object asynchronously.</span>

<span class="sd">    :param obj: object to delete</span>
<span class="sd">    :param recursive: if ``True`` also delete all other objects depends on object</span>
<span class="sd">    :param delete_nullable: if `True` and delete is recursive then delete even &#39;nullable&#39; dependencies</span>

<span class="sd">    For details please check out `Model.delete_instance()`_ in peewee docs.</span>

<span class="sd">    .. _Model.delete_instance(): http://peewee.readthedocs.io/en/latest/peewee/api.html#Model.delete_instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;delete_object() is deprecated, Manager.delete() &quot;</span>
                  <span class="s2">&quot;should be used instead&quot;</span><span class="p">,</span>
                  <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="c1"># Here are private calls involved:</span>
    <span class="c1"># - obj._pk_expr()</span>
    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="n">delete_nullable</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">query</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">model_class</span>
            <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delete_nullable</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">update</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">fk</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">delete</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">delete</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">update_object</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update object asynchronously.</span>

<span class="sd">    :param obj: object to update</span>
<span class="sd">    :param only: list or tuple of fields to updata, is `None` then all fields updated</span>

<span class="sd">    This function does the same as `Model.save()`_ for already saved object, but it</span>
<span class="sd">    doesn&#39;t invoke ``save()`` method on model class. That is important to know if you</span>
<span class="sd">    overrided save method for your model.</span>

<span class="sd">    .. _Model.save(): http://peewee.readthedocs.io/en/latest/peewee/api.html#Model.save</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Here are private calls involved:</span>
    <span class="c1">#</span>
    <span class="c1"># - obj._data</span>
    <span class="c1"># - obj._meta</span>
    <span class="c1"># - obj._prune_fields()</span>
    <span class="c1"># - obj._pk_expr()</span>
    <span class="c1"># - obj._dirty.clear()</span>
    <span class="c1">#</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;update_object() is deprecated, Manager.update() &quot;</span>
                  <span class="s2">&quot;should be used instead&quot;</span><span class="p">,</span>
                  <span class="ne">DeprecationWarning</span><span class="p">)</span>

    <span class="n">field_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
    <span class="n">pk_field</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">primary_key</span>

    <span class="k">if</span> <span class="n">only</span><span class="p">:</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">only</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pk_field</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">CompositeKey</span><span class="p">):</span>
        <span class="n">field_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pk_field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field_dict</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_prune_fields</span><span class="p">(</span><span class="n">field_dict</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">dirty_fields</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">update</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">field_dict</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">_pk_expr</span><span class="p">()))</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">rows</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="select"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.select">[docs]</a><span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform SELECT query asynchronously.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">SelectQuery</span><span class="p">),</span>\
        <span class="p">(</span><span class="s2">&quot;Error, trying to run select coroutine&quot;</span>
         <span class="s2">&quot;with wrong query class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">AsyncQueryWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>

    <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="insert"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.insert">[docs]</a><span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform INSERT query asynchronously. Returns last insert ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">InsertQuery</span><span class="p">),</span>\
        <span class="p">(</span><span class="s2">&quot;Error, trying to run insert coroutine&quot;</span>
         <span class="s2">&quot;with wrong query class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">is_insert_returning</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_return_id_list</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">query</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">last_insert_id_async</span><span class="p">(</span>
                <span class="n">cursor</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>

    <span class="k">return</span> <span class="n">result</span></div>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="update"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.update">[docs]</a><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform UPDATE query asynchronously. Returns number of rows updated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">UpdateQuery</span><span class="p">),</span>\
        <span class="p">(</span><span class="s2">&quot;Error, trying to run update coroutine&quot;</span>
         <span class="s2">&quot;with wrong query class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">rowcount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>
    <span class="k">return</span> <span class="n">rowcount</span></div>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="delete"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.delete">[docs]</a><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform DELETE query asynchronously. Returns number of rows deleted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">DeleteQuery</span><span class="p">),</span>\
        <span class="p">(</span><span class="s2">&quot;Error, trying to run delete coroutine&quot;</span>
         <span class="s2">&quot;with wrong query class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">rowcount</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>
    <span class="k">return</span> <span class="n">rowcount</span></div>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="count"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.count">[docs]</a><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">clear_limit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform *COUNT* aggregated query asynchronously.</span>

<span class="sd">    :return: number of objects in ``select()`` query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_distinct</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">_group_by</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">_limit</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">_offset</span><span class="p">:</span>
        <span class="c1"># wrapped_count()</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clear_limit</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">_limit</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">_offset</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">sql</span><span class="p">()</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="s1">&#39;SELECT COUNT(1) FROM (</span><span class="si">%s</span><span class="s1">) AS wrapped_select&#39;</span> <span class="o">%</span> <span class="n">sql</span>
        <span class="n">raw_query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">scalar</span><span class="p">(</span><span class="n">raw_query</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># simple count()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="n">query</span><span class="o">.</span><span class="n">_select</span> <span class="o">=</span> <span class="p">[</span><span class="n">peewee</span><span class="o">.</span><span class="n">fn</span><span class="o">.</span><span class="n">Count</span><span class="p">(</span><span class="n">peewee</span><span class="o">.</span><span class="n">SQL</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))]</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">scalar</span><span class="p">(</span><span class="n">query</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span></div>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="scalar"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.scalar">[docs]</a><span class="k">def</span> <span class="nf">scalar</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get single value from ``select()`` query, i.e. for aggregation.</span>

<span class="sd">    :return: result is the same as after sync ``query.scalar()`` call</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>
    <span class="k">if</span> <span class="n">row</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">as_tuple</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span></div>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">raw_query</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">RawQuery</span><span class="p">),</span>\
        <span class="p">(</span><span class="s2">&quot;Error, trying to run delete coroutine&quot;</span>
         <span class="s2">&quot;with wrong query class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">AsyncRawQueryWrapper</span><span class="p">(</span><span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">result</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="prefetch"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.prefetch">[docs]</a><span class="k">def</span> <span class="nf">prefetch</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="o">*</span><span class="n">subqueries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous version of the `prefetch()` from peewee.</span>

<span class="sd">    Returns Query that has already cached data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This code is copied from peewee.prefetch and adopted</span>
    <span class="c1"># to use async execute. Also it&#39;s a bit hacky, consider</span>
    <span class="c1"># it to be experimental!</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">subqueries</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="n">fixed_queries</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">prefetch_add_subquery</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">subqueries</span><span class="p">)</span>

    <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rel_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">prefetch_result</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fixed_queries</span><span class="p">):</span>
        <span class="n">query_model</span> <span class="o">=</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rel_model</span> <span class="ow">in</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">rel_models</span><span class="p">:</span>
                <span class="n">rel_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rel_model</span><span class="p">,</span> <span class="p">[])</span>
                <span class="n">rel_map</span><span class="p">[</span><span class="n">rel_model</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prefetch_result</span><span class="p">)</span>

        <span class="n">deps</span><span class="p">[</span><span class="n">query_model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">id_map</span> <span class="o">=</span> <span class="n">deps</span><span class="p">[</span><span class="n">query_model</span><span class="p">]</span>
        <span class="n">has_relations</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">rel_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">query_model</span><span class="p">))</span>

        <span class="c1"># NOTE! This is hacky, we perform async `execute()` and substitute result</span>
        <span class="c1"># to the initial query:</span>

        <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_qr</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">execute</span><span class="p">(</span><span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">_qr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">prefetch_result</span><span class="o">.</span><span class="n">store_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">id_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_relations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">rel_map</span><span class="p">[</span><span class="n">query_model</span><span class="p">]:</span>
                    <span class="n">rel</span><span class="o">.</span><span class="n">populate_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">deps</span><span class="p">[</span><span class="n">rel</span><span class="o">.</span><span class="n">model</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">prefetch_result</span><span class="o">.</span><span class="n">query</span></div>


<span class="c1">###################</span>
<span class="c1"># Result wrappers #</span>
<span class="c1">###################</span>

<span class="n">RESULTS_NAIVE</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">RESULTS_NAIVE</span>
<span class="n">RESULTS_MODELS</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">RESULTS_MODELS</span>
<span class="n">RESULTS_TUPLES</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">RESULTS_TUPLES</span>
<span class="n">RESULTS_DICTS</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">RESULTS_DICTS</span>
<span class="n">RESULTS_AGGREGATE_MODELS</span> <span class="o">=</span> <span class="n">peewee</span><span class="o">.</span><span class="n">RESULTS_AGGREGATE_MODELS</span>


<span class="k">class</span> <span class="nc">AsyncQueryWrapper</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Async query results wrapper for async `select()`. Internally uses</span>
<span class="sd">    results wrapper produced by sync peewee select query.</span>

<span class="sd">    Arguments:</span>

<span class="sd">        result_wrapper -- empty results wrapper produced by sync `execute()`</span>
<span class="sd">        call cursor -- async cursor just executed query</span>

<span class="sd">    To retrieve results after async fetching just iterate over this class</span>
<span class="sd">    instance, like you generally iterate over sync results wrapper.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="n">cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_result_wrapper</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get result wrapper class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">database</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_tuples</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_dicts</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_DICTS</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_naive</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">_joins</span> <span class="ow">or</span> <span class="n">query</span><span class="o">.</span><span class="n">verify_naive</span><span class="p">():</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAIVE</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_aggregate_rows</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_AGGREGATE_MODELS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_MODELS</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">QRW</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">get_query_meta</span><span class="p">())</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">fetchone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_wrapper</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span> <span class="ne">GeneratorExit</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result_wrapper</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cursor</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_wrapper</span><span class="o">.</span><span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AsyncRawQueryWrapper</span><span class="p">(</span><span class="n">AsyncQueryWrapper</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_result_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get raw query result wrapper class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">database</span>
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">_tuples</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_TUPLES</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">query</span><span class="o">.</span><span class="n">_dicts</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_DICTS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">QRW</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_result_wrapper</span><span class="p">(</span><span class="n">RESULTS_NAIVE</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">QRW</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="c1">############</span>
<span class="c1"># Database #</span>
<span class="c1">############</span>

<span class="k">class</span> <span class="nc">AsyncDatabase</span><span class="p">:</span>
    <span class="n">_loop</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># asyncio event loop</span>
    <span class="n">_allow_sync</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># whether sync queries are allowed</span>
    <span class="n">_async_conn</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># async connection</span>
    <span class="n">_async_wait</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># connection waiter</span>
    <span class="n">_task_data</span> <span class="o">=</span> <span class="kc">None</span>   <span class="c1"># asyncio per-task data</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;allow_sync&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;`.allow_sync` setter is deprecated, use either the &quot;</span>
                <span class="s2">&quot;`.allow_sync()` context manager or `.set_allow_sync()` &quot;</span>
                <span class="s2">&quot;method.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the event loop.</span>

<span class="sd">        If no event loop is provided explicitly on creating</span>
<span class="sd">        the instance, just return the current event loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">or</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">connect_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set up async connection on specified event loop or</span>
<span class="sd">        on default event loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deferred</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error, database not properly initialized &quot;</span>
                            <span class="s2">&quot;before opening connection&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">loop</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn_cls</span><span class="p">(</span>
                <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
                <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs_async</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span> <span class="o">=</span> <span class="n">TaskLocals</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span> <span class="o">=</span> <span class="n">conn</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">cursor_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acquire async cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_async</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_depth_async</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_conn_async</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">conn</span><span class="o">=</span><span class="n">conn</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_async</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">close_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close async connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_async_wait</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">push_transaction_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment async transaction depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_async</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_depth_async</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">depth</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">pop_transaction_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decrement async transaction depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_depth_async</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid async transaction depth value&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transaction_depth_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get async transaction depth.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">transaction_conn_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get async transaction connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_data</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">transaction_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to peewee `Database.transaction()` method, but returns</span>
<span class="sd">        asynchronous context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">atomic_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to peewee `Database.atomic()` method, but returns</span>
<span class="sd">        asynchronous context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">atomic</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">savepoint_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Similar to peewee `Database.savepoint()` method, but returns</span>
<span class="sd">        asynchronous context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">savepoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_allow_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow or forbid sync queries for the database. See also</span>
<span class="sd">        the :meth:`.allow_sync()` context manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">allow_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow sync queries within context. Close sync</span>
<span class="sd">        connection on exit if connected.</span>

<span class="sd">        Example::</span>

<span class="sd">            with database.allow_sync():</span>
<span class="sd">                PageBlock.create_table(True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_allow_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c1"># already closed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="o">=</span> <span class="n">old_allow_sync</span>

    <span class="k">def</span> <span class="nf">execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sync execute SQL query, `allow_sync` must be set to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Error, sync query is not allowed! Call the `.set_allow_sync()` &quot;</span>
            <span class="s2">&quot;or use the `.allow_sync()` context manager.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="ow">in</span> <span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_allow_sync</span><span class="p">,</span>
                        <span class="s2">&quot;Error, sync query is not allowed: </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1">##############</span>
<span class="c1"># PostgreSQL #</span>
<span class="c1">##############</span>


<span class="k">class</span> <span class="nc">AsyncPostgresqlConnection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous database connection pool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span> <span class="ow">or</span> <span class="n">aiopg</span><span class="o">.</span><span class="n">DEFAULT_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acquire connection from pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">acquire</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release connection to pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create connection pool asynchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">aiopg</span><span class="o">.</span><span class="n">create_pool</span><span class="p">(</span>
            <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Terminate all pool connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a cursor for the specified transaction connection</span>
<span class="sd">        or acquire from the pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_transaction</span> <span class="o">=</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># NOTE: `cursor.release` is an awaitable object!</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_cursor</span><span class="p">(</span>
            <span class="n">cursor</span><span class="p">,</span> <span class="n">in_transaction</span><span class="o">=</span><span class="n">in_transaction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cursor</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">release_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">in_transaction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release cursor coroutine. Unless in transaction,</span>
<span class="sd">        the connection is also released back to the pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">connection</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_transaction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AsyncPostgresqlMixin</span><span class="p">(</span><span class="n">AsyncDatabase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mixin for `peewee.PostgresqlDatabase` providing extra methods</span>
<span class="sd">    for managing async connection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aiopg</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">psycopg2</span>
        <span class="n">Error</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Error</span>

    <span class="k">def</span> <span class="nf">init_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn_cls</span><span class="o">=</span><span class="n">AsyncPostgresqlConnection</span><span class="p">,</span>
                   <span class="n">enable_json</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_hstore</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aiopg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error, aiopg is not installed!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn_cls</span> <span class="o">=</span> <span class="n">conn_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_json</span> <span class="o">=</span> <span class="n">enable_json</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_hstore</span> <span class="o">=</span> <span class="n">enable_hstore</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connect_kwargs_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connection parameters for `aiopg.Connection`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;minsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span><span class="p">,</span>
            <span class="s1">&#39;maxsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span><span class="p">,</span>
            <span class="s1">&#39;enable_json&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_json</span><span class="p">,</span>
            <span class="s1">&#39;enable_hstore&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enable_hstore</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">last_insert_id_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ID of last inserted row.</span>

<span class="sd">        NOTE: it&#39;s a copy-paste, not sure how to make it better</span>
<span class="sd">        https://github.com/05bit/peewee/blob/2.3.2/peewee.py#L2907</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">meta</span><span class="o">.</span><span class="n">schema</span>

        <span class="k">if</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">sequence</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">sequence</span>
        <span class="k">elif</span> <span class="n">meta</span><span class="o">.</span><span class="n">auto_increment</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_seq&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">db_column</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">seq</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT CURRVAL(&#39;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">PostgresqlDatabase</span><span class="p">(</span><span class="n">AsyncPostgresqlMixin</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">PostgresqlDatabase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PosgreSQL database driver providing **single drop-in sync** connection</span>
<span class="sd">    and **single async connection** interface.</span>

<span class="sd">    Example::</span>

<span class="sd">        database = PostgresqlDatabase(&#39;test&#39;)</span>

<span class="sd">    See also:</span>
<span class="sd">    http://peewee.readthedocs.io/en/latest/peewee/api.html#PostgresqlDatabase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_async</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_speedups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@use_speedups</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">use_speedups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PooledPostgresqlDatabase</span><span class="p">(</span><span class="n">AsyncPostgresqlMixin</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">PostgresqlDatabase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;PosgreSQL database driver providing **single drop-in sync**</span>
<span class="sd">    connection and **async connections pool** interface.</span>

<span class="sd">    :param max_connections: connections pool size</span>

<span class="sd">    Example::</span>

<span class="sd">        database = PooledPostgresqlDatabase(&#39;test&#39;, max_connections=20)</span>

<span class="sd">    See also:</span>
<span class="sd">    http://peewee.readthedocs.io/en/latest/peewee/api.html#PostgresqlDatabase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_connections&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_connections&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_async</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_speedups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@use_speedups</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">use_speedups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="c1">#########</span>
<span class="c1"># MySQL #</span>
<span class="c1">#########</span>


<span class="k">class</span> <span class="nc">AsyncMySQLConnection</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous database connection pool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acquire connection from pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">acquire</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release connection to pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create connection pool asynchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">aiomysql</span><span class="o">.</span><span class="n">create_pool</span><span class="p">(</span>
            <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span>
            <span class="n">connect_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Terminate all pool connections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get cursor for connection from pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_transaction</span> <span class="o">=</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># NOTE: `cursor.release` is an awaitable object!</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_cursor</span><span class="p">(</span>
            <span class="n">cursor</span><span class="p">,</span> <span class="n">in_transaction</span><span class="o">=</span><span class="n">in_transaction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cursor</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">release_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">in_transaction</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release cursor coroutine. Unless in transaction,</span>
<span class="sd">        the connection is also released back to the pool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">connection</span>
        <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_transaction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MySQLDatabase</span><span class="p">(</span><span class="n">AsyncDatabase</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">MySQLDatabase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MySQL database driver providing **single drop-in sync** connection</span>
<span class="sd">    and **single async connection** interface.</span>

<span class="sd">    Example::</span>

<span class="sd">        database = MySQLDatabase(&#39;test&#39;)</span>

<span class="sd">    See also:</span>
<span class="sd">    http://peewee.readthedocs.io/en/latest/peewee/api.html#MySQLDatabase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aiomysql</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pymysql</span>
        <span class="n">Error</span> <span class="o">=</span> <span class="n">pymysql</span><span class="o">.</span><span class="n">Error</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aiomysql</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error, aiomysql is not installed!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_conn_cls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;async_conn&#39;</span><span class="p">,</span> <span class="n">AsyncMySQLConnection</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connect_kwargs_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connection parameters for `aiomysql.Connection`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;minsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span><span class="p">,</span>
            <span class="s1">&#39;maxsize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span><span class="p">,</span>
            <span class="s1">&#39;autocommit&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">last_insert_id_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ID of last inserted row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_increment</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_speedups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@use_speedups</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">use_speedups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PooledMySQLDatabase</span><span class="p">(</span><span class="n">MySQLDatabase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MySQL database driver providing **single drop-in sync**</span>
<span class="sd">    connection and **async connections pool** interface.</span>

<span class="sd">    :param max_connections: connections pool size</span>

<span class="sd">    Example::</span>

<span class="sd">        database = MySQLDatabase(&#39;test&#39;, max_connections=10)</span>

<span class="sd">    See also:</span>
<span class="sd">    http://peewee.readthedocs.io/en/latest/peewee/api.html#MySQLDatabase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_connections</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;min_connections&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_connections</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;max_connections&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1">##############</span>
<span class="c1"># Sync utils #</span>
<span class="c1">##############</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">sync_unwanted</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context manager for preventing unwanted sync queries.</span>
<span class="sd">    `UnwantedSyncQueryError` exception will raise on such query.</span>

<span class="sd">    NOTE: sync_unwanted() context manager is **deprecated**, use</span>
<span class="sd">    database&#39;s `.allow_sync()` context manager or `Manager.allow_sync()`</span>
<span class="sd">    context manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;sync_unwanted() context manager is deprecated, &quot;</span>
                  <span class="s2">&quot;use database&#39;s `.allow_sync()` context manager or &quot;</span>
                  <span class="s2">&quot;`Manager.allow_sync()` context manager. &quot;</span><span class="p">,</span>
                  <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">old_allow_sync</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">_allow_sync</span>
    <span class="n">database</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">yield</span>
    <span class="n">database</span><span class="o">.</span><span class="n">_allow_sync</span> <span class="o">=</span> <span class="n">old_allow_sync</span>


<span class="k">class</span> <span class="nc">UnwantedSyncQueryError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception which is raised when performing unwanted sync query.</span>

<span class="sd">    NOTE: UnwantedSyncQueryError is deprecated, `assert` is used instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;UnwantedSyncQueryError is deprecated, &quot;</span>
                      <span class="s2">&quot;assert is used instead.&quot;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>


<span class="c1">################</span>
<span class="c1"># Transactions #</span>
<span class="c1">################</span>


<div class="viewcode-block" id="transaction"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.transaction">[docs]</a><span class="k">class</span> <span class="nc">transaction</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous context manager (`async with`), similar to</span>
<span class="sd">    `peewee.transaction()`. Will start new `asyncio` task for</span>
<span class="sd">    transaction if not started already.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">loop</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="transaction.commit"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.transaction.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;COMMIT&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;BEGIN&#39;</span><span class="p">)</span></div>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="transaction.rollback"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.transaction.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;ROLLBACK&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">begin</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;BEGIN&#39;</span><span class="p">)</span></div>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">current_task</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The transaction must run within a task&quot;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">push_transaction_async</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth_async</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;BEGIN&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth_async</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">pop_transaction_async</span><span class="p">()</span></div>


<div class="viewcode-block" id="savepoint"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.savepoint">[docs]</a><span class="k">class</span> <span class="nc">savepoint</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous context manager (`async with`), similar to</span>
<span class="sd">    `peewee.savepoint()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="n">sid</span> <span class="ow">or</span> <span class="s1">&#39;s&#39;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">compiler</span><span class="p">()</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">)</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="savepoint.commit"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.savepoint.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;RELEASE SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span></div>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<div class="viewcode-block" id="savepoint.rollback"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.savepoint.rollback">[docs]</a>    <span class="k">def</span> <span class="nf">rollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;ROLLBACK TO SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span></div>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s1">&#39;SAVEPOINT </span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quoted_sid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                    <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="atomic"><a class="viewcode-back" href="../sanic_peewee.html#sanic_peewee.atomic">[docs]</a><span class="k">class</span> <span class="nc">atomic</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Asynchronous context manager (`async with`), similar to</span>
<span class="sd">    `peewee.atomic()`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_depth_async</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">savepoint_async</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">transaction_async</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">())</span>

    <span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
    <span class="k">def</span> <span class="nf">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctx</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span></div>


<span class="c1">####################</span>
<span class="c1"># Internal helpers #</span>
<span class="c1">####################</span>

<span class="k">def</span> <span class="nf">_get_exception_wrapper</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get peewee exceptions context manager for database</span>
<span class="sd">    in backward compatible manner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">,</span> <span class="n">peewee</span><span class="o">.</span><span class="n">ExceptionWrapper</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">exception_wrapper</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">database</span><span class="o">.</span><span class="n">exception_wrapper</span><span class="p">()</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">_run_sql</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run SQL operation (query or command) against database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

    <span class="k">with</span> <span class="n">_get_exception_wrapper</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">database</span><span class="o">.</span><span class="n">cursor_async</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">cursor</span><span class="o">.</span><span class="n">release</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">cursor</span>


<span class="nd">@asyncio</span><span class="o">.</span><span class="n">coroutine</span>
<span class="k">def</span> <span class="nf">_execute_query_async</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute query and return cursor object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">_run_sql</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="o">*</span><span class="n">query</span><span class="o">.</span><span class="n">sql</span><span class="p">()))</span>


<span class="k">class</span> <span class="nc">TaskLocals</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple `dict` wrapper to get and set values on per `asyncio`</span>
<span class="sd">    task basis.</span>

<span class="sd">    The idea is similar to thread-local data, but actually *much* simpler.</span>
<span class="sd">    It&#39;s no more than a &quot;sugar&quot; class. Use `get()` and `set()` method like</span>
<span class="sd">    you would to for `dict` but values will be get and set in the context</span>
<span class="sd">    of currently running `asyncio` task.</span>

<span class="sd">    When task is done, all saved values is removed from stored data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get value stored for current running task. Optionally</span>
<span class="sd">        you may provide the default value. Raises `KeyError` when</span>
<span class="sd">        can&#39;t get the value and no default one is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set value stored for current running task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No task is currently running&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get dict stored for current running task. Return `None`</span>
<span class="sd">        or an empty dict if no data was found depending on the</span>
<span class="sd">        `create` argument value.</span>

<span class="sd">        :param create: if argument is `True`, create empty dict</span>
<span class="sd">                       for task, default: `False`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="o">.</span><span class="n">current_task</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
            <span class="n">task_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">create</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">del_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">del_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Delete data for task from stored data dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">task</span><span class="p">)]</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, hsz.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>